rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }
    match /organizations/{orgName} {
    	function isOrgMember(uid) {
      	return exists(/databases/$(database)/documents/organizations/$(orgName)/users/$(uid))
      }
    	function isOrgAdmin(uid) {
      	return exists(/databases/$(database)/documents/organizations/$(orgName)/admins/$(uid))
      }
    	function hasInvite() {
      	return request.resource.data.inviteLink == get(/databases/$(database)/documents/organizations/$(orgName)).inviteLink
      }
    	allow read, write: if isOrgMember(request.auth.uid);

      match /groups/{document=**} {
      	allow read: if isOrgMember(request.auth.uid)
      }
      match /students/{document=**} {
      	allow read: if isOrgMember(request.auth.uid)
      }
      match /users/{document=**} {
      	allow read, write: if isOrgAdmin(request.auth.uid)
      	allow create: if hasInvite()
      }
    }
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }
  }
}
